version: v1beta9
images:
  php:
    image: ${PHP_IMAGE}
    preferSyncOverRebuild: true
    injectRestartHelper: true
    appendDockerfileInstructions:
    - USER root
    dockerfile: Dockerfile
deployments:
- name: nginx-config
  kubectl:
    manifests:
    - deploy/nginx-config-configmap.yaml
- name: app
  helm:
    componentChart: true
    values:
      containers:
      - name: nginx
        image: ${NGINX_IMAGE}
        volumeMounts:
        - containerPath: /etc/nginx/nginx.conf
          volume:
            name: nginx-config
            subPath: nginx.conf
            readOnly: true
        - containerPath: /shared
          volume:
            name: ${SHARED_VOLUME_NAME}
            subPath: /shared
            readOnly: true
      - name: php
        image: ${PHP_IMAGE}
        command:
        - "/bin/sh"
        args:
        - "-c"
        - "mkdir -p /shared/var/www/html/public || true; cp -r /var/www/html/public/* /shared/var/www/html/public/; php /var/www/html/artisan migrate && php-fpm"
        volumeMounts:
        - containerPath: /shared
          volume:
            name: ${SHARED_VOLUME_NAME}
            subPath: /shared
            readOnly: false
      service:
        ports:
        - port: 80
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: ${SHARED_VOLUME_NAME}
        size: ${SHARED_VOLUME_SIZE}
      labels:
        app: nginx
        portforward: true
    recreate: true
- name: mysql
  helm:
    componentChart: false
    chart:
      name: ${MYSQL_CHART}
      version: ${MYSQL_CHART_VERSION}
    values:
      auth:
        rootPassword: ${MYSQL_ROOT_PASSWORD}
        database: ${MYSQL_DATABASE}
        username: ${MYSQL_USER}
        password: ${MYSQL_PASSWORD}
- name: redis
  helm:
    componentChart: false
    chart:
      name: ${REDIS_CHART}
      version: ${REDIS_CHART_VERSION}
    values:
      networkPolicy:
        enabled: true
        allowExternal: true
      password: ${REDIS_PASSWORD}
      cluster:
        enabled: false
dev:
  ports:
  - labelSelector:
      app: nginx
      portforward: true
    forward:
    - port: 8080
      remotePort: 80
  open:
  - url: http://localhost:8080
  sync:
  - imageName: php
    excludePaths:
    - .git/
    uploadExcludePaths:
    - Dockerfile
    - "*.Dockerfile"
    - devspace.yaml
    - vendor/
    - node_modules/
    - deploy/
    downloadExcludePaths:
    - vendor/
    - node_modules/
    onUpload:
      restartContainer: true
  logs:
    showLast: 100
    sync: true
    selectors:
    - containerName: php
    - containerName: nginx
    - containerName: mysql
    - containerName: redis
profiles:
- name: production
  patches:
  - op: remove
    path: images.php.appendDockerfileInstructions
  - op: remove
    path: images.php.injectRestartHelper
  - op: remove
    path: deployments.name=app.helm.values.containers[0].command
  - op: remove
    path: deployments.name=app.helm.values.containers[0].args
- name: interactive
  patches:
  - op: add
    path: dev.interactive
    value:
      defaultEnabled: true
  - op: add
    path: images.php.entrypoint
    value:
    - sleep
    - "9999999999"
commands:
- name: php
  command: devspace enter php
vars:
