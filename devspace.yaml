version: v1beta9
images:
  app:
    image: ${APP_IMAGE}
    preferSyncOverRebuild: true
    injectRestartHelper: true
    appendDockerfileInstructions:
    - USER root
deployments:
- name: mysql
  helm:
    componentChart: false
    chart:
      name: mysql
      version: 8.4.4
      repo: https://charts.bitnami.com/bitnami
    values:
      image:
        tag: ${DB_MYSQL_VERSION}
      auth:
        rootPassword: ${DB_ROOT_PASSWORD}
        database: ${DB_DATABASE}
        username: ${DB_USERNAME}
        password: ${DB_PASSWORD}
      primary:
        service:
          port: ${DB_PORT}
- name: nginx-config
  kubectl:
    manifests:
    - deploy/nginx-config-configmap.yaml
- name: app
  helm:
    componentChart: true
    values:
      replicas: 1
      containers:
      - name: nginx
        image: nginx:${NGINX_VERSION}
        volumeMounts:
        - containerPath: /etc/nginx/nginx.conf
          volume:
            name: nginx-config
            subPath: nginx.conf
            readOnly: true
        - containerPath: /assets
          volume:
            name: ${ASSET_VOLUME_NAME}
            subPath: /assets
            readOnly: true
      - name: php
        image: ${APP_IMAGE}
        command:
        - "/bin/sh"
        args:
        - "-c"
        - |
          cp -r /var/www/html/public/* /assets/;

          php-fpm
        env:
        - name: APP_DEBUG
          value: ${APP_DEBUG}
        - name: APP_KEY
          value: $!{APP_KEY}
        - name: DB_HOST
          value: $!{DB_HOST}
        - name: DB_PORT
          value: $!{DB_PORT}
        - name: DB_USERNAME
          value: $!{DB_USERNAME}
        - name: DB_PASSWORD
          value: $!{DB_PASSWORD}
        - name: REDIS_PASSWORD
          value: $!{REDIS_PASSWORD}
        volumeMounts:
        - containerPath: /assets
          volume:
            name: ${ASSET_VOLUME_NAME}
            subPath: /assets
            readOnly: false
      initContainers:
      - name: php-init
        image: ${APP_IMAGE}
        command:
        - "/bin/sh"
        args:
        - "-c"
        - |
          while ! mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USERNAME" -p"$DB_PASSWORD" >/dev/null 2>&1;
          do
            echo "Waiting for database to start..."
            sleep 3
          done

          php artisan migrate
        env:
        - name: DB_HOST
          value: $!{DB_HOST}
        - name: DB_PORT
          value: $!{DB_PORT}
        - name: DB_USERNAME
          value: $!{DB_USERNAME}
        - name: DB_PASSWORD
          value: $!{DB_PASSWORD}
      service:
        ports:
        - port: 80
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: ${ASSET_VOLUME_NAME}
        size: ${ASSET_VOLUME_SIZE}
    recreate: true
- name: redis
  helm:
    componentChart: false
    chart:
      name: redis
      version: 12.8.3
      repo: https://charts.bitnami.com/bitnami
    values:
      image:
        tag: ${REDIS_VERSION}
      networkPolicy:
        enabled: true
        allowExternal: true
      password: ${REDIS_PASSWORD}
      cluster:
        enabled: false
dev:
  ports:
  - imageName: app
    forward:
    - port: 8080
      remotePort: 80
  open:
  - url: http://localhost:8080
  sync:
  - imageName: app
    excludePaths:
    - .git/
    - vendor/
    - node_modules/
    - storage
    - .devspace
    - README.md
    uploadExcludePaths:
    - Dockerfile
    - devspace.yaml
    - deploy/
    onUpload:
      restartContainer: true
      execRemote:
        onBatch:
          command: sh
          args: ["-c", "cp -r /var/www/html/public/* /assets/"]
  logs:
    showLast: 100
    sync: true
    selectors:
    - containerName: nginx
  autoReload:
    paths:
    - Dockerfile
    images:
    - app
vars:
- name: APP_IMAGE
  question: Which image repository should your image be pushed to? (e.g. dockerhubuser/image, gcr.io/project/image)
- name: DB_PASSWORD
  password: true
- name: DB_ROOT_PASSWORD
  password: true
- name: REDIS_PASSWORD
  password: true
- name: APP_DEBUG
  question: Enable / disable debugging
- name: test
commands:
- name: artisan
  command: devspace enter -c php -- php artisan
  description: Entry point for artisan commands.
- name: composer
  command: devspace enter -c php -- composer
  description: Entry point for composer commands.
- name: php
  command: devspace enter -c php -- php
  description: Entry point for PHP commands.
- name: npm
  command: devspace enter -c php -- npm
  description: Entry point for NPM commands.
- name: update-db-user
  command: |
    devspace enter --wait -l app.kubernetes.io/name=mysql -- sh -c "
      while ! mysql -h'${DB_HOST}' -P'${DB_PORT}' -u'${DB_USERNAME}' -p'${DB_PASSWORD}' >/dev/null 2>&1;
      do
        echo 'Waiting for database to be ready...';
        sleep 3;
      done;

      echo \"CREATE USER IF NOT EXISTS '${DB_USERNAME}'@'%' IDENTIFIED BY '${DB_PASSWORD}'; ALTER USER '${DB_USERNAME}' IDENTIFIED BY '${DB_PASSWORD}';\" | mysql -u root -p'${DB_ROOT_PASSWORD}'"
  description: Update MySQL DB user/password.
- name: generate-key
  command: TMP_FILE=.devspace/app_key.tmp && docker run --rm -v $PWD:/app composer/composer bash -c "composer install --no-dev --no-interaction && php artisan key:generate --show >$TMP_FILE" && devspace set var APP_KEY="$(cat $TMP_FILE)" && rm $TMP_FILE
  description: Generate APP_KEY.
- name: mysql
  command: devspace enter -c mysql -- mysql -h'${DB_HOST}' -P'${DB_PORT}' -u'${DB_USERNAME}' -p'${DB_PASSWORD}' '${DB_DATABASE}'
  description: Enter to MySQL shell.
  
hooks:
- command: "devspace"
  args: ["run", "update-db-user"]
  when:
    after:
      deployments: mysql_REMOVE_THIS_POSTFIX_AFTER_FIX
profiles:
- name: production
  patches:
  - op: remove
    path: images.app.appendDockerfileInstructions[0]
  - op: remove
    path: images.app.injectRestartHelper
  - op: add
    path: images.app.appendDockerfileInstructions
    value:
      RUN npm run prod
  - op: replace
    path: deployments.name=app.helm.values.containers.name=php.env.name=APP_DEBUG
    value: "false"
  - op: add
    path: images.app.appendDockerfileInstructions
    value:
      RUN php artisan optimize 
- name: development
  patches:
  - op: add
    path: images.app.appendDockerfileInstructions
    value:
      RUN npm run dev
- name: interactive
  patches:
  - op: add
    path: dev.interactive
    value:
      defaultEnabled: true
  - op: replace
    path: deployments.name=app.helm.values.containers.name=php.args
    value:
    - "-c"
    - "sleep 9999999999"
