version: v1beta9
images:
  php:
    image: ${PHP_IMAGE}
    preferSyncOverRebuild: true
    injectRestartHelper: true
    appendDockerfileInstructions:
    - USER root
    dockerfile: Dockerfile
deployments:
- name: ${APP_DEPLOYMENT_NAME}
  helm:
    componentChart: true
    values:
      containers:
      - name: nginx
        image: ${NGINX_IMAGE}
        volumeMounts:
        - containerPath: /etc/nginx/nginx.conf
          volume:
            name: ${NGINX_CONFIG_CONFIGMAP_NAME}
            subPath: nginx.conf
            readOnly: true
        - containerPath: /shared
          volume:
            name: ${SHARED_VOLUME_NAME}
            subPath: /shared
            readOnly: true
        command:
        - "/bin/sh"
        args:
        - "-c"
        - "mkdir -p /var/www/html/public && touch /var/www/html/public/index.php && nginx -g 'daemon off;'"
      - name: php
        image: ${PHP_IMAGE}
        command:
        - "/bin/sh"
        args:
        - "-c"
        - "php /var/www/html/artisan migrate && php-fpm"
        volumeMounts:
        - containerPath: /shared
          volume:
            name: ${SHARED_VOLUME_NAME}
            subPath: /shared
            readOnly: false
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: ${SHARED_VOLUME_NAME}
        size: ${SHARED_VOLUME_SIZE}
      labels:
        app: nginx
        portforward: true
- name: ${MYSQL_DEPLOYMENT_NAME}
  helm:
    componentChart: false
    chart:
      name: ${MYSQL_CHART}
      version: ${MYSQL_CHART_VERSION}
    values:
      auth:
        rootPassword: ${MYSQL_ROOT_PASSWORD}
        database: ${MYSQL_DATABASE}
        username: ${MYSQL_USER}
        password: ${MYSQL_PASSWORD}
- name: ${REDIS_DEPLOYMENT_NAME}
  helm:
    componentChart: false
    chart:
      name: ${REDIS_CHART}
      version: ${REDIS_CHART_VERSION}
    values:
      networkPolicy:
        enabled: true
        allowExternal: true
      password: ${REDIS_PASSWORD}
      cluster:
        enabled: false
dev:
  ports:
  - labelSelector:
      app: nginx
      portforward: true
    forward:
    - port: 8080
      remotePort: 80
  open:
  - url: http://localhost:8080
  sync:
  - imageName: php
    excludePaths:
    - .git/
    uploadExcludePaths:
    - Dockerfile
    - "*.Dockerfile"
    - devspace.yaml
    - vendor/*
    - node_modules/*
    onUpload:
      restartContainer: true
profiles:
- name: production
  patches:
  - op: remove
    path: images.app.appendDockerfileInstructions
  - op: remove
    path: images.app.injectRestartHelper
- name: interactive
  patches:
  - op: add
    path: dev.interactive
    value:
      defaultEnabled: true
  - op: add
    path: images.app.entrypoint
    value:
    - sleep
    - "9999999999"
commands:
- name: php
  command: devspace enter php
vars:
hooks:
- command: "/bin/sh"
  args:
    - "-c"
    - "kubectl delete configmap ${NGINX_CONFIG_CONFIGMAP_NAME} || true; kubectl create configmap ${NGINX_CONFIG_CONFIGMAP_NAME} --from-file=./deploy/nginx.conf"
  when:
    before:
      deployments: ${APP_DEPLOYMENT_NAME}
- command: "/bin/sh"
  args:
    - "-c"
    - "kubectl delete configmap ${NGINX_CONFIG_CONFIGMAP_NAME}"
  when:   
    after:
      purgeDeployments: ${APP_DEPLOYMENT_NAME}